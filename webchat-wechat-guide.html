<!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>WebChat与微信公众号对接接口说明</title>
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
        
        <style>
.task-list-item { list-style-type: none; } .task-list-item-checkbox { margin-left: -20px; vertical-align: middle; }
</style>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        
        
    </head>
    <body class="vscode-light">
        <p>#WebChat与微信公众号对接接口说明</p>
<p>webchat已经可以和我们自己的livebot(微信公众号托管服务)对接，实现在微信公众号界面直接与客服聊天，如果其他公众号也想实现此功能，就需要按如下接口来实现。</p>
<p>接口都是使用http协议，post方式，参数直接通过body中传递json格式字符串（content-type: application/json）
主要分两部分：</p>
<blockquote>
<p>一部分是webchat提供的接口，让微信托管服务来调用，这部分我们已经提供
另一部分是微信托管服务提供，让webchat来调用，这部分需要对方实现</p>
</blockquote>
<p>具体接口定义如下：</p>
<p>##一.webchat端提供的接口（从微信托管服务发送请求到webchat)</p>
<ul>
<li>从微信端发出聊天开始请求，通常发出后返回一个当前的排队位置</li>
</ul>
<pre><code><code><div>http://xxxxx/webchat/createcon.do
接收参数:
{
	openId: &quot;xxxxx&quot;,//当前微信用户的openId
	skillGroup: 1,//chat排队的队列号
	nickname: &quot;昵称&quot;,//（可选）
	headImgUrl: &quot;头像地址&quot;,//（可选）
	requestTime: 1512026448289,//请求发出的时间戳
	epid: &quot;服务号的id&quot;,//（可选）
	serviceAccount: &quot;服务号名称&quot;,//（可选）
	agentId: &quot;SELITE&quot;, //（可选）要排给的坐席id，只有当要固定排给某个人时候才需要传递
	from: &quot;WECHAT&quot;, //（可选）请求来源 分为:PC MOBILE WECHAT APP 不同来源会让坐席端看到不同客户的默认头像
	brand: &quot;&quot;,//（可选）请求来源2，作为第二个来源字段
	tracks: &quot;&quot; //（可选）客户浏览轨迹 json字符串，具体格式查看相关文档
}

返回参数：
{
	result: 1,//1表示成功，详细看请求结果代码
	message: &quot;ok&quot;,//结果的备注说明
	queueLength: 1,//当前队列长度
	sessionId: 123,//当持久队列中的持久会话，则直接返回此会话id（非持久会话时候是不会返回此参数）
	agentId: &quot;SELITE&quot;,//专属坐席id（非持久会话时候是不会返回此参数）
	agentName: &quot;伊力特&quot;//专属坐席名称（非持久会话时候是不会返回此参数）
}

</div></code></code></pre>
<ul>
<li>从微信端发消息给坐席，有的多媒体消息会有一个媒体id，webchat之后会通过这个媒体id去微信服务器上获取真正的媒体文件</li>
</ul>
<pre><code><code><div>http://xxxxx/webchat/getmsg.do
接收参数：
{
	sessionId: 123,//会话id
	epid: &quot;服务号id&quot;,//(可选)
	agentId: &quot;SELITE&quot;,//坐席id
	openId: &quot;xxxxx&quot;,//
	msgType: &quot;text&quot;,//消息类型，包括了（text，image，voice，video，link，location）
	content: &quot;&quot;//消息内容，不同消息类型，消息的内容格式也不同，除了text直接是字符串，其他都是一个json对象
}

image的content:
{
	mediaId: &quot;&quot;//图片对应的微信媒体id
}
voice的content:
{
	recognition: &quot;&quot;,//语音识别出来的文字
	format: &quot;&quot;,//语音文件格式
	mediaId: &quot;&quot;//语音对应的微信媒体id
}
video的content:
{
	thumbMediaId: &quot;&quot;,//缩略图的微信媒体id
	mediaId: &quot;&quot;//视频对应的微信媒体id
}
link的content:
{
	url: &quot;&quot;,//链接url
	title: &quot;&quot;,//链接标题
	description: &quot;&quot;//描述信息
}
location的content:
{
	x: 121.23,//经度
	y: 34.213,//纬度
	scale: 1,//坐标地图大小
	label: &quot;&quot;//坐标标签
}

返回参数：
{
	result: 1,
	message: &quot;ok&quot;
}

</div></code></code></pre>
<ul>
<li>从微信端结束聊天</li>
</ul>
<pre><code><code><div>http://xxxx/webchat/closecon.do
接收参数
{
	sessionId: 123,//会话id
	epid: &quot;服务号id&quot;//(可选)
}

返回参数：
{
	result: 1,
	message: &quot;ok&quot;
}

</div></code></code></pre>
<ul>
<li>从微信端提交满意度</li>
</ul>
<pre><code><code><div>http://xxxx/webchat/ratesession.do
接收参数
{
	chatSessionId: 123,//会话id
	ratingId: 1,//满意度评分，具体值由具体项目业务决定
	ratingComment: &quot;&quot;,//满意度备注信息
	epid: &quot;服务号id&quot;,//(可选)
}

返回参数：
{
	result: 1,
	message: &quot;ok&quot;
}

</div></code></code></pre>
<ul>
<li>从微信端发送机器人转接到人工客服的接口信息</li>
</ul>
<pre><code><code><div>http://xxxx/webchat/transferCon.do
接收参数
{
	sessionId: 123,//会话id
	openId: 1, //客户openId
	createTime: &quot;&quot;,//当前时间
	transferInfo: &quot;&quot;,//转接信息内容
	epid: &quot;服务号id&quot;,//(可选)
}

返回参数：
{
	result: 1,//1表示成功，详细看请求结果代码
	message: &quot;ok&quot;,//结果的备注说明
	queueLength: 1,//当前队列长度
	sessionId: 123,//当持久队列中的持久会话，则直接返回此会话id（非持久会话时候是不会返回此参数）
	agentId: &quot;SELITE&quot;,//专属坐席id（非持久会话时候是不会返回此参数）
	agentName: &quot;伊力特&quot;//专属坐席名称（非持久会话时候是不会返回此参数）
}
</div></code></code></pre>
<ul>
<li>从微信端发起取消聊天的接口</li>
</ul>
<pre><code><code><div>http://xxxx/webchat/cancelRequest.do
接收参数
{
	sessionId: 123,//会话id
	openId: 1,//客户openId
	requestId: 1,//请求会话id
	createTime: &quot;&quot;,//当前时间
	epid: &quot;服务号id&quot;,//(可选)
}

返回参数：
{
	result: 1,
	message: &quot;ok&quot;
}
</div></code></code></pre>
<ul>
<li>从微信端发送请求获取当前用户的排队的位置</li>
</ul>
<pre><code><code><div>    http://xxxx/webchat/getQueueLength.do
接收参数
{
	requestId: 123,//请求会话id
	epid: &quot;服务号id&quot;,//(可选)
}

返回参数：
{
	result: 1,
	message: &quot;ok&quot;,
	orderInQueue: 0, //位置信息
}

</div></code></code></pre>
<ul>
<li>从微信端发送请求获取当前会话的会话状态</li>
</ul>
<pre><code><code><div>http://xxxx/webchat/pulse.do
接收参数
{
	sessionId: 123,//会话id
	openId: 1,//客户openId
	createTime: &quot;&quot;,//当前时间
	transferInfo: &quot;&quot;,//转接信息内容
	epid: &quot;服务号id&quot;,//(可选)
}

返回参数：
{
	result: 1 //返回1正在聊天中
}

</div></code></code></pre>
<p>##二. 微信托管服务提供的接口（从webchat端发消息给微信托管服务）</p>
<ul>
<li>通知聊天开始。当客户发出过聊天请求后，请求经过排队，分配给了某个坐席，坐席接受了请求，这时候聊天会话就建立了，webchat也就会调用这个接口，通知微信托管服务。</li>
</ul>
<pre><code><code><div>http://xxxx/ari/create
接收参数：
{
	result: 1,//排队结果，1表示成功
	message: &quot;ok&quot;,//备注消息
	agentId: &quot;&quot;,//坐席id
	agentName: &quot;&quot;,//坐席名
	sessionId: 123,//会话id
	responseTime: 1512026448289,//发送时间
	openId: &quot;&quot;,//客户openId
	epid: &quot;服务号id&quot;,
}

返回参数：
{
	result: 1,
	message: &quot;ok&quot;
}
</div></code></code></pre>
<ul>
<li>发送消息给微信</li>
</ul>
<pre><code><code><div>http://xxxx/ari/msg
接受参数:
{
	sessionId: 123,//会话id
	agentId: &quot;SELITE&quot;,//坐席id
	openId: &quot;&quot;,//客户openId
	epid: &quot;&quot;,//服务号id
	msgTime: 12341234324,//发送时间戳
	content: &quot;&quot;//消息内容，内容是带有html片段的富文本，需要微信端自己解析其中的表情或者图片
}

返回参数：
{
	result: 1,
	message: &quot;ok&quot;
}
</div></code></code></pre>
<ul>
<li>坐席端通知微信聊天结束</li>
</ul>
<pre><code><code><div>http://xxxx/ari/close
接受参数:
{
	closeTime: 12341234324,//结束时间戳
	agentId: &quot;&quot;,//坐席id
	sessionId: 123,//会话id
	openId: &quot;&quot;,//客户openId
	epid: &quot;&quot;//服务号id
}

返回参数：
{
	result: 1,
	message: &quot;ok&quot;
}
</div></code></code></pre>
<ul>
<li>坐席端通知微信坐席信息</li>
</ul>
<pre><code><code><div>http://xxxx/ari/sessionAgentsUpdate
接受参数:
{
    &quot;agentId&quot;: &quot;SELITE&quot;,//坐席id
    &quot;sessionId&quot;: 123,
    &quot;openId&quot;: &quot;&quot;,
    &quot;agents&quot;: [{
            &quot;id&quot;: &quot;000169&quot;,
            &quot;name&quot;: &quot;nsnp663&quot;
        }
    ]
}

返回参数：
{
	result: 1,
	message: &quot;ok&quot;
}
</div></code></code></pre>
<ul>
<li>坐席端通知微信坐席推送满意度</li>
</ul>
<pre><code><code><div>http://xxxx/ari/pushRating
接受参数:
{
    &quot;sessionId&quot;: 123,
    &quot;openId&quot;: &quot;&quot;,
    &quot;ratings&quot;: [] //满意度信息
}

返回参数：
{
	result: 1,
	message: &quot;ok&quot;
}
</div></code></code></pre>
<ul>
<li>坐席端通知微信坐席推送的更新请求状态信息</li>
</ul>
<pre><code><code><div>http://xxxx/ari/updateRequestStatus

接受参数:
{
    &quot;requestId&quot;: &quot;SELITE&quot;,//会话id
    &quot;requestStatus&quot;: 123,
    &quot;openId&quot;: &quot;&quot;, //客户openId
    &quot;queueLength&quot;: &quot;&quot;,
    &quot;message&quot;: &quot;&quot;
}

返回参数：
{
	result: 1,
	message: &quot;ok&quot;
}
</div></code></code></pre>
<ul>
<li>获取媒体文件</li>
</ul>
<pre><code><code><div>http://xxxx/ari/getMedia
接受参数:
{
	mediaId: &quot;xxx&quot;,//媒体id
	agentId: &quot;&quot;,//坐席id
	sessionId: 123,//会话id
	openId: &quot;&quot;,//客户openId
	epid: &quot;&quot;//服务号id
}

返回参数：
{
	code: 1,
	message: "" //downloadUrl 返回当前的这个多媒体的访问地址 会拼接地址 LIVEBOT_WANADDR + "/wechat/" + serviceAccountId +  "/" + type + "?file=" + message 作为文件的访问地址
}
</div></code></code></pre>
<p>##常量说明</p>
<p>聊天请求状态码</p>
<pre><code><code><div>WAITING = 0;//等待中
ACCEPTED = 1;//坐席接受
REFUSED = 2;//坐席拒绝
TIMEOUT = 3;//排队超时
DROPPED = 4;//异常丢失
NO_AGENT_ONLINE = 5;//无坐席在线
OFF_HOUR = 6;//不在工作时间
CANCELED_BY_CLIENT = 7;//被客户取消
ENTERPRISE_WECHAT_ACCEPTED = 11;//坐席企业号接收
</div></code></code></pre>
<p>请求结果代码</p>
<pre><code><code><div>public static final int SUCCESS = 1;
public static final int REQUEST_ALREADY_IN_ROULTING = -1;
public static final int ALREADY_IN_CHATTING = -2;
public static final int NOT_IN_WORKTIME = -3;
public static final int INVAILD_SKILLGROUP = -4;
public static final int NO_AGENT_ONLINE = -5;
public static final int INVAILD_TO_USER_ID = -9;
public static final int NO_SERVED_AGENT_FOUND = -10;
public static final int INTERNAL_ERROR = -100;
</div></code></code></pre>

    </body>
    </html>
